version: '3.6'
services:

  wordpress-for-tests:
    image: versionpress/wordpress:php7.2-apache
    ports:
      - "80:80"
    volumes:
      - wordpress-files:/var/www/html:z
    links:
      - mysql-for-tests:mysql
    working_dir: /var/www/html/wptest
    environment:
      WORDPRESS_DB_PASSWORD: r00tpwd

  mysql-for-tests:
    image: mysql:5.7
    ports:
      - "3306:3306"
    volumes:
      - db_data_for_tests:/var/lib/mysql:z
    environment:
      MYSQL_ROOT_PASSWORD: r00tpwd

  adminer:
    image: adminer
    ports:
      - "8099:8080"

  # See `tests-with-wordpress` for a service that also starts WordPress.
  tests:
    image: versionpress/wordpress:cli
    environment:
      VP_DIR: /opt/versionpress
      PHP_IDE_CONFIG: serverName=VersionPress-tests
    volumes:
      # !!! This must be kept in sync with wordpress-cli-image/Dockerfile
      - wordpress-files:/var/www/html:z
      - test-logs:/var/opt/versionpress/logs:z
      - ./plugins/versionpress:/opt/versionpress:ro,z
      - ./ext-libs:/opt/ext-libs:ro,z
      - wpcli-cache:/var/www/.wp-cli:z
    working_dir: /opt/versionpress/tests
    command: ../vendor/bin/phpunit --verbose --colors -c phpunit.xml --testdox-text /var/opt/versionpress/logs/testdox.txt

  tests-with-wordpress:
    image: versionpress/wordpress:cli
    environment:
      VP_DIR: /opt/versionpress
      PHP_IDE_CONFIG: serverName=VersionPress-tests
    volumes:
      # !!! This must be kept in sync with wordpress-cli-image/Dockerfile
      - wordpress-files:/var/www/html:z
      - test-logs:/var/opt/versionpress/logs:z
      - ./plugins/versionpress:/opt/versionpress:ro,z
      - ./ext-libs:/opt/ext-libs:ro,z
      - wpcli-cache:/var/www/.wp-cli:z
    working_dir: /opt/versionpress/tests
    command: ../vendor/bin/phpunit --verbose --colors -c phpunit.xml --testdox-text /var/opt/versionpress/logs/testdox.txt
    links:
      - selenium-hub
      - wordpress-for-tests

  selenium-hub:
    # Standalone Firefox is enough but could also be a full grid setup, hence the service name
    image: selenium/standalone-firefox

  copy-files-to-host:
    image: alpine
    volumes:
      - wordpress-files:/tmp/wp
      - ./dev-env/wp-for-tests:/tmp/wp-copy
      - test-logs:/tmp/test-logs
      - ./dev-env/test-logs:/tmp/test-logs-copy
    command: '/bin/sh -c "cp -a /tmp/test-logs/. /tmp/test-logs-copy/; cp -a /tmp/wp/. /tmp/wp-copy/"'

volumes:
  db_data_for_tests:
  wpcli-cache:
  wordpress-files:
  test-logs:
